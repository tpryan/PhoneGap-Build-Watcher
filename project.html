<!DOCTYPE html>
<html>
  <head>
    <title>Build Watcher</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <script type="text/javascript" charset="utf-8" src="phonegap.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/webtoolkit.base64.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/main.js"></script>
    <script type="text/javascript" charset="utf-8">

    var attempts = 0;
    var baseURL = "https://build.phonegap.com";
    var appApiPath = "/api/v1/apps/";
    var username = "";
    var password = "";
    var id = "";
    var lastStatus = "";
    
    var platform = "";
    var urlPlatform = "";

    if (isInPhoneGap()){
      document.addEventListener("deviceready", init, false);
    }
    else{
      $(document).ready(init);
    }

    function init(){
        username = localStorage.getItem("username");
        password = localStorage.getItem("password");
        id = getURLParameter("id");
        platform = determinePlatform();
        urlPlatform = determineURLPlatform(platform);
        getProjectDetails();
    }



    function setDeviceInfo(){
        platform = determinePlatform();
        urlPlatform = determineURLPlatform(platform);
        getProjectDetails();
    }


    function getProjectDetails()
    {

        $.ajax({
            url: baseURL + appApiPath + id,
            success: parseRequest, 
            type:"get",
            error: errorHandler,
            headers:{
                "Authorization": make_basic_auth(username,password)
            },       
            cache:false,
            crossDomain:true
        });

    }

    function errorHandler(error){
      alert("We have a problem.");
    }

    function rebuild()
    {
        event.preventDefault();
        $.ajax({
            url: baseURL + appApiPath + id + "/build/" ,
            success: parseRequest, 
            type:"POST",
            error: errorHandler,
            headers:{
                "Authorization": make_basic_auth(username,password)
            },       
            cache:false,
            crossDomain:true
        });

        return false;

    }
    function handleReBuildSuccess(response){
        getProjectDetails();
    }


    

    function determinePlatform(){
        if(typeof(device) != "undefined"){
            return device.platform;
        }
        else{
            return "Not a supported platform";
        }
    }

    function determineURLPlatform(platform){
        var urlPlatform = platform.toLowerCase();
        
        if (platform == "Not a supported platform"){
            urlPlatform = "android";
        }
        if (platform == "iPad" || platform == "iPhone"  || platform == "iPod"){
            urlPlatform = "ios";
        }
        return urlPlatform;
    }

    function getProjectInfo(response,platform){
        

        var result = new Object();

        if (urlPlatform == "ios"){
            result['download'] = "/apps/" + response['id'] + "/download/ios";
        }
        else{
            result['download'] = response.download[urlPlatform];
        }

        result['status'] = response.status[urlPlatform];
        result['title'] = response.title;
        result['description'] = response.description;
        result['platform'] = platform + " (" + urlPlatform + ")";

        return result;
    }

    function populateDetails(details){
        var statusClass = "warning";
        $('#title').html(details.title);
        $('#description').html(details.description);
        $('#platform').html(details.platform);
        
        $('#attemptcount').html(attempts);

        if(lastStatus != details.status){
            if (details.status == "complete"){

                if (attempts > 0){
                    showAlert();
                }
                $('#attempts').html('<span class="label label-success">complete</span>');
                statusClass = "success";
                attempts = 0;
                $('#downloadbtn').attr("href" ,baseURL +  details.download);
            }    
            else{
                $('#attempts').html('Waiting for rebuild <i class="icon-cog status-indicator"></i> <span id="attemptcount">' + attempts + '</span>');
                $('#download').html('');
            }

            $('#status').html('<span class="label label-'+statusClass+'">' + details.status + '</span>');
        }

        
        lastStatus = details.status;
    }

    // this function should parse responses.. you can do anything you need..
    // you can make it general so it would parse all the responses the page receives based on a response field
    function parseRequest(response)
    {
        try // try to output this to the javascript console
        {
            console.log("Getting Project details");
            var results =getProjectInfo(response,determinePlatform());
            console.log("Populating UI");
            populateDetails(results);

            console.log(results.status);
            if (results.status == "pending"){
                console.log("Scheduling another attempt");
                attempts = attempts + 1;
                setTimeout("getProjectDetails()", 1000);
                $('#downloadbtn').addClass("disabled");
                $('#downloadbtn').removeClass("btn-primary");
            }
            else{
                setTimeout("getProjectDetails()", 10000);
                $('#downloadbtn').removeClass("disabled");
                $('#downloadbtn').addClass("btn-primary");
            }

        }
        catch(an_exception) // alert for the users that don't have a javascript console
        {
            console.log(response);
            console.log(an_exception);
            alert(an_exception);
        }
    }

    // Show a custom alert
    //
    function showAlert() {


        if(typeof(device) != "undefined"){
            navigator.notification.alert(
                'Proejct ready!',  // message
                null,         // callback
                'PhoneGap Build ',            // title
                'Ok!'                  // buttonName
            );


            playBeep();
            vibrate();
        }
        else{
            alert('Project Ready!')
        }

       
    }

    function playBeep() {
        navigator.notification.beep(3);
    }

    // Vibrate for 2 seconds
    //
    function vibrate() {
        navigator.notification.vibrate(1000);
    }

    function checkDownload() {
        if ($('#downloadbtn').attr("class").indexOf("disabled") >= 0){
            event.preventDefault();
            return false;
        }
    }

    </script>
  </head>
 <body>

  <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
            <a class="brand" href="./index.html">PhoneGap Build Watcher</a>
            <a class="btn pull-right" href="./clear.html"><i class="icon-lock"></i> <span class="listtext">Logout</span></a>
            <a href="./list.html" class="btn pull-right" ><i class="icon-list"></i> <span class="listtext">Project List</span></a>

        </div>
      </div>
    </div>

    <div class="container">
        <table class="table table-bordered">
            <tr><th>Title</th><td id="title">Loading <i class="icon-cog status-indicator"></i></td></tr>
            <tr><th>Description</th><td id="description">Loading <i class="icon-cog status-indicator"></i></td></tr>
            <tr><th>Platform</th><td id="platform">Loading <i class="icon-cog status-indicator"></i></td></tr>
            <tr><th>Project Status</th><td id="status">Loading <i class="icon-cog status-indicator"></i></td></tr>
            <tr><th>Rebuild Status</th><td id="attempts">Loading <i class="icon-cog status-indicator"></i></td></tr>
        </table>    

        <ul id="actionlist">
            <li>
                <a href="" id="downloadbtn" class="btn btn-large  disabled" onclick="checkDownload()" target="_blank"> 
                    <i class="icon-download icon-white"></i> Download App
                </a>
            </li>
            <li>
                <a href="" id="reloadbtn" class="btn btn-large" onclick="getProjectDetails()">
                    <i class="icon-repeat"></i> Refresh Status
                </a>
            </li>
            <li>
                <a href="" id="rebuildbtn" class="btn btn-large" onclick="rebuild()">
                    <i class="icon-cog"></i> Rebuild Application
                </a>
            </li>
        </ul>
    </div> 
  </body>
</html>



